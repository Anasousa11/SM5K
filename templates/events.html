{% extends "base.html" %}

{% block title %}Sessions & Runs | SinMancha{% endblock %}

{% block content %}
<section class="page-header">
  <h1>Sessions & Runs</h1>
  <p>Find your next run, session or challenge.</p>
</section>

<section class="container" style="padding-top: 0; padding-bottom: 1rem;">
  <form method="get" class="filters-form" style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end;">
    <div>
      <label style="font-size:0.85rem;">Type</label><br>
      <select name="type">
        <option value="">All</option>
        <option value="running_club" {% if type_filter == "running_club" %}selected{% endif %}>Running club</option>
        <option value="class" {% if type_filter == "class" %}selected{% endif %}>Class / session</option>
        <option value="challenge" {% if type_filter == "challenge" %}selected{% endif %}>Challenge</option>
      </select>
    </div>

    <div>
      <label style="font-size:0.85rem;">Min distance (km)</label><br>
      <input type="number" step="0.1" name="min_distance" value="{{ min_distance|default:'' }}">
    </div>

    <div>
      <label style="font-size:0.85rem;">Max distance (km)</label><br>
      <input type="number" step="0.1" name="max_distance" value="{{ max_distance|default:'' }}">
    </div>

    <div>
      <button type="submit" class="btn btn-secondary">Apply filters</button>
      <a href="{% url 'events' %}" class="btn btn-outline-secondary">Reset</a>
    </div>
  </form>
</section>

<section class="container pb-4">
  {% if events %}
    <div class="row g-4">
      {% for event in events %}
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">

              <div class="d-flex justify-content-between align-items-start gap-2">
                <h5 class="card-title mb-1">{{ event.title }}</h5>
                <span class="badge text-bg-dark">{{ event.get_event_type_display }}</span>
              </div>

              <p class="card-text text-muted mb-2">
                {{ event.date|date:"M d, Y" }} • {{ event.start_time|time:"H:i" }}
                {% if event.location %}<br><small>{{ event.location }}</small>{% endif %}
              </p>

              {% if event.description %}
                <p class="card-text">{{ event.description|truncatewords:22 }}</p>
              {% endif %}

              <div class="mt-2">
                {% if event.distance_km %}
                  <span class="badge text-bg-secondary">Distance: {{ event.distance_km }} km</span>
                {% endif %}
                {% if event.target_reps %}
                  <span class="badge text-bg-secondary">Target: {{ event.target_reps }} reps</span>
                {% endif %}
              </div>

              <div class="mt-3">
                {% if event.is_full %}
                  <span class="badge text-bg-danger">Fully booked</span>
                {% else %}
                  <span class="badge text-bg-success">{{ event.spots_left }} spots left</span>
                {% endif %}

                {% if event.price_member or event.price_non_member %}
                  <div class="small text-muted mt-2">
                    {% if event.price_member %}Member: £{{ event.price_member }}{% endif %}
                    {% if event.price_non_member %}{% if event.price_member %} • {% endif %}Non-member: £{{ event.price_non_member }}{% endif %}
                  </div>
                {% else %}
                  <div class="small text-muted mt-2">Free</div>
                {% endif %}
              </div>

              <div class="mt-auto pt-3 d-flex gap-2">
                {# Optional: only show Details if you actually have event_detail route #}
                {# <a class="btn btn-outline-secondary" href="{% url 'event_detail' event.id %}">Details</a> #}

                {% if user.is_authenticated and user.client_profile %}
                  {% if event.id in joined_ids %}
                    <form method="post" action="{% url 'leave_event' event.id %}">
                      {% csrf_token %}
                      <button class="btn btn-secondary" type="submit">Joined ✓ (Leave)</button>
                    </form>
                  {% else %}
                    <form method="post" action="{% url 'join_event' event.id %}">
                      {% csrf_token %}
                      <button class="btn btn-primary" type="submit" {% if event.is_full %}disabled{% endif %}>Join</button>
                    </form>
                  {% endif %}
                {% else %}
                  <a class="btn btn-primary" href="{% url 'account_login' %}">Login to join</a>
                {% endif %}
              </div>

            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="container">No upcoming events yet.</p>
  {% endif %}
</section>
{% endblock %}
