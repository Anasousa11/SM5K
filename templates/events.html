{% extends "base.html" %}
{% load static %}
{% load club_extras %}

{% block title %}Sessions & Runs | SinMancha{% endblock %}

{% block content %}
<section class="events-header">
  <div class="container">
    <h1>Events & Challenges</h1>
    <p>Join runs, sessions, and challenges that push your limits.</p>
  </div>
</section>

<!-- FILTERS -->
<section class="container events-filters-section">
  <form method="get" class="events-filters">
    <div class="filter-group">
      <label>Event Type</label>
      <select name="type">
        <option value="">All Events</option>
        <option value="running_club" {% if type_filter == "running_club" %}selected{% endif %}>Running Club</option>
        <option value="class" {% if type_filter == "class" %}selected{% endif %}>Class / Session</option>
        <option value="challenge" {% if type_filter == "challenge" %}selected{% endif %}>Challenge</option>
      </select>
    </div>

    <div class="filter-group">
      <label>Distance (km)</label>
      <div class="filter-range">
        <input type="number" step="0.1" name="min_distance" placeholder="Min" value="{{ min_distance|default:'' }}">
        <span>—</span>
        <input type="number" step="0.1" name="max_distance" placeholder="Max" value="{{ max_distance|default:'' }}">
      </div>
    </div>

    <div class="filter-actions">
      <button type="submit" class="btn btn-primary">Filter</button>
      <a href="{% url 'events' %}" class="btn btn-secondary">Reset</a>
    </div>
  </form>
</section>

<!-- EVENTS GRID -->
<section class="container events-grid-section">
  {% if events %}
    <div class="events-grid">
      {% for event in events %}
        <article class="event-card">
          <!-- EVENT IMAGE -->
          <div class="event-image">
            {% if event.event_type == "running_club" %}
              <img src="{% static 'img/running.jpg' %}" alt="{{ event.title }}">
            {% elif event.event_type == "challenge" %}
              <img src="{% static 'img/burp.jpg' %}" alt="{{ event.title }}">
            {% elif event.event_type == "class" %}
              <img src="{% static 'img/push.jpg' %}" alt="{{ event.title }}">
            {% else %}
              <img src="{% static 'img/running.jpg' %}" alt="{{ event.title }}">
            {% endif %}
            <div class="event-type-badge">{{ event.get_event_type_display }}</div>
          </div>

          <!-- EVENT DETAILS -->
          <div class="event-content">
            <h3 class="event-title">{{ event.title }}</h3>

            <div class="event-meta">
              <div class="meta-item">
                <span class="meta-label">Date & Time</span>
                <span class="meta-value">{{ event.date|date:"M d, Y" }} • {{ event.start_time|time:"H:i" }}</span>
              </div>
              {% if event.location %}
                <div class="meta-item">
                  <span class="meta-label">Location</span>
                  <span class="meta-value">{{ event.location }}</span>
                </div>
              {% endif %}
              {% if event.distance_km %}
                <div class="meta-item">
                  <span class="meta-label">Distance</span>
                  <span class="meta-value">{{ event.distance_km }} km</span>
                </div>
              {% endif %}
              {% if event.target_reps %}
                <div class="meta-item">
                  <span class="meta-label">Target</span>
                  <span class="meta-value">{{ event.target_reps }} reps</span>
                </div>
              {% endif %}
            </div>

            {% if event.description %}
              <p class="event-description">{{ event.description|truncatewords:20 }}</p>
            {% endif %}

            <!-- AVAILABILITY & PRICE -->
            <div class="event-footer">
              <div class="event-availability">
                {% if event.is_full %}
                  <span class="availability-badge full">Fully Booked</span>
                {% else %}
                  <span class="availability-badge available">{{ event.spots_left }} spots</span>
                {% endif %}
              </div>

              <div class="event-price">
                {% if event.price_member or event.price_non_member %}
                  {% if event.price_member %}<span>Member: £{{ event.price_member }}</span>{% endif %}
                {% else %}
                  <span class="price-free">Free</span>
                {% endif %}
              </div>
            </div>

            <!-- ACTION BUTTON -->
            <div class="event-action">
              {% if user.is_authenticated and user|has_attr:'client_profile' %}
                {% if event.id in joined_ids %}
                  <form method="post" action="{% url 'leave_event' event.id %}" style="width: 100%;">
                    {% csrf_token %}
                    <button class="btn btn-secondary" type="submit" style="width: 100%;">Joined ✓</button>
                  </form>
                {% else %}
                  <form method="post" action="{% url 'join_event' event.id %}" style="width: 100%;">
                    {% csrf_token %}
                    <button class="btn btn-primary" type="submit" style="width: 100%;" {% if event.is_full %}disabled{% endif %}>Join Event</button>
                  </form>
                {% endif %}
              {% else %}
                <a class="btn btn-primary" href="{% url 'account_login' %}" style="width: 100%; text-align: center;">Login to Join</a>
              {% endif %}
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <h2>No upcoming events</h2>
      <p>Check back soon for new runs, sessions, and challenges!</p>
    </div>
  {% endif %}
</section>
{% endblock %}
